---
title: "__SkyTrax: Passenger Reviews of Airline Seats__"
author: "Noel Kaso"
date: "30/10/2020"
output:
  html_document: 
    toc: true
    toc_depth: 2
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(visdat)
library(gridExtra)
library(broom)
```
***
# __DESCRIPTION__
### Exploring airline seat reviews

The [SkyTrax](https://www.airlinequality.com) website allows passengers to review many aspects of air travel - originally created as an independent customer forum, it has become a leading review site for airlines, airports and associated reviews (REF: https://www.airlinequality.com/about-us/ )

This report considers passenger airline seat reviews and seeks to answer a series of questions about these reviews with respect to the major airlines and aircraft types. 

***
# __QUESTIONS__

### The Questions
1. | Which airlines are the most frequently rated and which shows the best Overall Rating performance?
2. | How does the variable Overall Rating vary amoungst the most frequently rated airlines?
3. | How is the average of the Category Ratings distributed across the most frequently rated airlines?
4. | How does Overall Rating vary between the major aircraft makes: Boeing and Airbus?
5. | Which aircraft models show the best Overall Rating results?
6. | What relationship exists between the Average Overall Rating and the Average Category Ratings and can the Average Overall Rating be predicted by one of more of these variables?

***
# __EXPLANATION__
### An expalation of the data set
The data set considered contains airlines passenger reviews of aircraft seats. The data was scraped in 2015 from [SkyTrax](https://www.airlinequality.com). The set contains 1,258 reviews (observations) comprising 21 variables, including the passenger rating of the airline seat overall (score out of 10) and a rating over a number of categories (score out of 5). These ratings are referred to the Category Ratings and cover: seat legroom, width, recline, aisle space, viewing tv, power supply and seat storage. The airline name, aircraft make and model are also captured. Whether the passenger would recommend the airline seat is captured in the variable Recommended as numeric indicator. 

Four variables exhibited a degree of missingness (REF??) greater than 90% and these were excluded from the analysis. Passenger reviews where the category rating variable  Viewing TV Rating was missign occured to a low degree, therefore these observations were removed from analysis by filtering. Overall the  variables most relevant to the questions are 100% present in the data set.

### Approach to tidying and wrangling 
Variables relevant to the questions were included in the tidy data using the Select (REF??) function as this allows for focus. 

The variable Aircraft was split into Aircraft Make and Aircraft Model by the Separate (REF??) function. The values of these two new variables were made more consistent using three Mutate (REF??) operations with if_else fucntions (REF??). This was done to achieve a consistent value in each. 

Filtering was applied to the Aircraft Make as the questions posed relate to Boeing and Airbus. 

String Replace and Remove (REF??) allowed for the values in the new variables to be improved by removing non-alphanumeric characters and giving a  single string without additional characters of sub-model descriptors such as "-200LR", "-300W". 

The tidied data set contains 1,226 observations across 14 variables relevant to the questions posed in the following section. 

### Calculating an average of categroy ratings for each row
To calculate the average of the category ratings for each review a Row-Wise (REF??) process was required with the Mutate function. This is set-out in Question 3. 

Further explanations of the approach to the tidy data set are set-out in the following sections for each question. 


***
# __METHODS AND VISUALISATIONS__

### Working with the data
This section set-outs the methods used to read, wrangle and tidy the data set. Firstly, a visualisation of missingness has been considered using the vis_miss function (REF??). Then a tidy data set has been formed (seats_tidy) and further methods applied under each question. 

#### Read the data
```{r read csv}
seats <- read_csv("https://raw.githubusercontent.com/quankiquanki/skytrax-reviews-dataset/master/data/seat.csv")
# Examine the data
glimpse(seats)
```
#### Examine missing data
```{r missingness plot}
vis_miss(seats, sort_miss = TRUE)
```
In the data set four variables exhibit a very high degree of missingness, that is, greater than 90%: two of the seat category ratings (Power Supply and Storage), the Date Flown and Traveller Type. All four variables were excluded from the analysis. The category rating variable Viewing TV Rating is missing from a small number of observations (passenger reviews), therefore these reviews were removed from analysis by filtering. Overall the key variables most relevant to the questions are 100% present in the data set.

#### Tidy and wrangle the data
```{r tidy, wrangle and glimpse}
# Define the set of aircraft models where aircraft_make = Airbus
airbus_mods <- c("A300", "A310-300","A319","A320","A321", "A320-200","A330","A330-200","A330-300","A340","A340-300","A340-500","A340-600","A380", "A380-800","A300-600", "A321/A320", "Airbus","AIRBIS")

# Define the set of aircraft models where aircraft_make = Boeing
boeing_mods <- c("B737-900", "B767", "B767-300", "B777", "B777-200", "B777-200LR", "B777-200ER", "B777-300", "B777-300ER", "B777-300", "B757-200", "B747-300", "Boeing747", "B777-300ER", "B747-400", "B757", "B757-200","B777-300W", "Boeing")

# Create a tidy data set wtih only the relevant variables (columns)
# Using the Mutate function improve the consistency of values for aircraft_make and aircraft_model
seats_tidy <- seats %>% 
              select(-link, -title, -author, -date_flown, -type_traveller, -content, -power_supply_rating, -seat_storage_rating) %>%
              separate(col = "aircraft", c("aircraft_make", "aircraft_model"), sep = " ") %>%
              mutate(aircraft_model = ifelse(is.na(aircraft_model), aircraft_make, aircraft_model)) %>%
              # Using mutate replace missing aircraft_models wth the value from aircraft_make
              mutate(aircraft_make = ifelse(aircraft_make %in% airbus_mods, "AIRBUS", aircraft_make)) %>%
              mutate(aircraft_make = ifelse(aircraft_make %in% boeing_mods, "BOEING", aircraft_make)) %>%
              filter(aircraft_make %in% c("AIRBUS", "BOEING")) # Filter the data set for Airbus and Boeing

# Using Sting Replace and Remove to improve the consistency of values for aircraft_make and aircraft_model so that all models are a single string without additional characters of sub-model descriptors: eg: remove "-200LR", "-300W" 
seats_tidy$airline_name <- str_replace_all(seats_tidy$airline_name,"-"," ")
seats_tidy$airline_name <- toupper(seats_tidy$airline_name)

seats_tidy$aircraft_model <- str_replace_all(seats_tidy$aircraft_model,"B","")
seats_tidy$aircraft_model <- str_replace_all(seats_tidy$aircraft_model,"ER","")
seats_tidy$aircraft_model <- str_replace_all(seats_tidy$aircraft_model,"LR","")
seats_tidy$aircraft_model <- str_remove(seats_tidy$aircraft_model, "-.*")
seats_tidy$aircraft_model <- str_remove(seats_tidy$aircraft_model, "/.*")
seats_tidy$seat_layout <- str_replace_all(seats_tidy$seat_layout,"-","x")

glimpse(seats_tidy)
```
***
## QUESTION 1: 
### Which airlines are the most frequently rated and which shows the best Overall Rating performance?

#### The 12 most frequently rated airlines
```{r group and summarise}
by_airline <- seats_tidy %>% group_by(airline_name) %>%
                             summarise(num_of_reviews = n(),
                                       mean_overall_rating = mean(overall_rating),
                                       median_overall_rating = median(overall_rating),
                                       sdev = sd(overall_rating)) %>% 
                             filter(num_of_reviews >= 39) %>% 
                             arrange(desc(num_of_reviews))
                            
by_airline
```

```{r ggplot bar chart}
by_airline %>% ggplot(aes(x = reorder(airline_name,num_of_reviews), y = num_of_reviews, fill = airline_name))+
               geom_bar(stat ="identity") +
               theme_minimal() +
               theme(axis.text.x=element_text(size=6, hjust=1), 
                     axis.ticks.x=element_blank(), 
                     legend.position="none") +
               scale_fill_brewer(palette = "Paired") +
               coord_flip() +
               labs(title = "The 12 Most Frequently Rated Airlines", 
                    x = "AIRLINE", 
                    y = "Number of Reviews")
              
```

***
## QUESTION 2:
### Distribution of overall rating for top 12 most frequently rated airlines
```{r ggplot sbs boxplot}
most_rated_airlines <- seats_tidy %>% filter(airline_name %in% c("AIR FRANCE","AMERICAN AIRLINES","BRITISH AIRWAYS","CATHAY PACIFIC AIRWAYS","EMIRATES","ETIHAD AIRWAYS","LUFTHANSA","QANTAS AIRWAYS","QATAR AIRWAYS","SINGAPORE AIRLINES","VIRGIN ATLANTIC AIRWAYS", "KLM ROYAL DUTCH AIRLINES"))

most_rated_airlines %>% ggplot(aes( x = reorder(airline_name, overall_rating), y = overall_rating, colour = airline_name))+
                        geom_boxplot() +
                        geom_jitter(alpha = 0.2) +
                        facet_wrap(recommended~.) +
                        theme_minimal() +
                        theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), legend.text = element_text(size=6)) +
                        scale_colour_brewer(palette = "Paired") +
                        labs(title = "Distribution of Overall Rating by the 12 Most Frequently Rated Airlines", 
                             subtitle = "0 = Not Recommended, 1 = Recommended",
                             x = "AIRLINE", 
                             y = "Overall Rating")
```

***
## QUESTION 3:
### Distribution of average category rating for the 10 most frequently rated airlines

#### Calculate the mean of the category ratings
```{r row-wise mutate}
most_rated_airlines <- most_rated_airlines %>% filter(!is.na(viewing_tv_rating)) %>%
              rowwise() %>% 
              mutate(mean_cat_rating = mean(seat_legroom_rating:viewing_tv_rating))

glimpse(most_rated_airlines)
```

```{r ggplot density}

most_rated_airlines %>% ggplot(aes(mean_cat_rating)) +
                        geom_density() +
                        facet_wrap(.~airline_name) +
                        theme_minimal() +
                        theme(axis.text.x=element_text(size=6),axis.text.y=element_text(size=6)) +
                        labs(title = "Density Plot of Average Category Rating for the 12 Most Frequenlty Rated Airlines",
                             x = "Average Category Rating", 
                             y = "Density of Average Category Rating")
               
```

```{r ggplot sbs boxplot2}
most_rated_airlines %>% ggplot(aes( x = airline_name, y = mean_cat_rating, color = airline_name))+
                        geom_boxplot() +
                        geom_jitter(alpha = 0.2) +
                        theme_minimal() +
                        theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), legend.text = element_text(size=6)) +
                        scale_color_brewer(palette = "Paired") +
                        labs(title = "Distribution of Average Category Rating by Most Frequently Rated Airlines", 
                             x = "AIRLINE",
                             y = "Mean of the 5 Category Ratings")
```

***
## QUESTION 4:
### Distribtution of overall rating variable by aircraft make
```{r ggplot sbs boxplot3}
seats_tidy %>% ggplot(aes( x = aircraft_make, y = overall_rating))+
               geom_boxplot() +
               geom_jitter(alpha = 0.1) +
               theme_minimal() +
               labs(title = "Distributin of Overall Rating: AIRBUS v BOEING", 
                    x = "AIRCRAFT MAKE", 
                    y = "Overall Rating")
```

***
## QUESTION 5:
### Distribtution of overall rating variable by aircraft modlel
```{r ggplot sbs boxplot4}
seats_tidy %>% filter(aircraft_model %in% c("737","747","757","767","777","787","A319","A320","A321","A330","A340","A380")) %>%
               ggplot(aes( x = aircraft_model, y = overall_rating, group = aircraft_model))+
               geom_boxplot() +
               geom_jitter(alpha = 0.1) +
               theme_minimal() +
               labs(title = "Distribution of Overall Rating by Aircraft Model", 
                    x = "AIRCRAFT MODEL", 
                    y = "Overall Rating")
```

***
## QUESTION 6:
### Does x predict y

#### Calculate the average (mean) of the Overall Rating variable and each category rating variable

```{r}
all_airlines_summary <- seats_tidy %>% group_by(airline_name) %>%
                        summarise(av_overall_rating = mean(overall_rating, na.rm = TRUE),
                                  av_legroom= mean(seat_legroom_rating, na.rm = TRUE),
                                  av_recline = mean(seat_recline_rating, na.rm = TRUE),
                                  av_width = mean(seat_width_rating, na.rm = TRUE),
                                  av_aspace = mean(aisle_space_rating, na.rm = TRUE),
                                  av_tv = mean(viewing_tv_rating, na.rm = TRUE)) %>%
                        arrange(desc(av_overall_rating))
                        
all_airlines_summary     
``` 

#### Plot a linear model of each average category variable against the Average Overall Rating variable
```{r}
lm1 <- all_airlines_summary %>% ggplot(aes(x = av_legroom, y = av_overall_rating)) +
                                geom_point() +
                                geom_smooth(method = "lm", se=FALSE) +
                                theme_minimal() +
                                theme(axis.text.x=element_text(size=8),axis.text.y=element_text(size=8)) +
                                labs( x = "Average Legroom Rating", y = "Average Overall Rating")

lm2 <- all_airlines_summary %>% ggplot(aes(x = av_recline, y = av_overall_rating)) +
                                geom_point() +
                                geom_smooth(method = "lm", se=FALSE) +
                                theme_minimal() +
                                theme(axis.text.x=element_text(size=8),axis.text.y=element_text(size=8)) +
                                labs( x = "Average Seat Recline Rating", y = NULL)

lm3 <- all_airlines_summary %>% ggplot(aes(x = av_width, y = av_overall_rating)) +
                                geom_point() +
                                geom_smooth(method = "lm", se=FALSE) +
                                theme_minimal() +
                                theme(axis.text.x=element_text(size=8),axis.text.y=element_text(size=8)) +
                                labs( x = "Average Seat Width Rating", y = NULL)

lm4 <- all_airlines_summary %>% ggplot(aes(x = av_aspace, y = av_overall_rating)) +
                                geom_point() +
                                geom_smooth(method = "lm", se=FALSE) +
                                theme_minimal() +
                                theme(axis.text.x=element_text(size=8),axis.text.y=element_text(size=8)) +
                                labs( x = "Average Aisle Space Rating", y = "Average Overall Rating")

lm5 <- all_airlines_summary %>% ggplot(aes(x = av_tv, y = av_overall_rating)) +
                                geom_point() +
                                geom_smooth(method = "lm", se=FALSE) +
                                theme_minimal() +
                                theme(axis.text.x=element_text(size=8),axis.text.y=element_text(size=8)) +
                                labs( x = "Average Viewing TV Rating", y = NULL)

grid.arrange(lm1, lm2, lm3,lm4,lm5, ncol=3)
```

#### Calculate the Correlation Coefficient between each average category variable and the Average Overall Rating variable
```{r}
all_airlines_summary %>% summarise(cor(av_legroom, av_overall_rating),
                                   cor(av_recline, av_overall_rating),
                                   cor(av_width, av_overall_rating),
                                   cor(av_aspace, av_overall_rating)) %>%
                                   gather("Variables","Correlation Coeff")
```

#### Model 1: a single variable model considering average aisle space rating

$$av.overall.rating = \beta_0 + \beta_1 av.aspace + \varepsilon$$

```{r}
overall_model_1 <- lm(av_overall_rating ~ av_aspace, data = all_airlines_summary)

summary(overall_model_1)
tidy(overall_model_1)
glance(overall_model_1)
```

#### Model 2: an interaction beween the average aisle space and average seat recline ratings

$$av.overall.rating = \beta_0 + \beta_1 av.aspace * \beta_2 av.recline + \varepsilon$$
```{r}
overall_model_2 <- lm(av_overall_rating ~ av_aspace * av_recline, data = all_airlines_summary)

summary(overall_model_2)
tidy(overall_model_2)
glance(overall_model_2)
```

#### Model 3: an interaction between average aisle space, average seat recline and average seat width ratings

$$av.overall.rating = \beta_0 + \beta_1 av.aspace * \beta_2 av.recline * \beta_3 av.width + \varepsilon$$

```{r}
overall_model_3 <- lm(av_overall_rating ~ av_aspace * av_recline * av_width, data = all_airlines_summary)

summary(overall_model_3)
tidy(overall_model_3)
glance(overall_model_3)
```

Model 2 is an improvement on Model 1 - the adjusted R-Squared value has increased and the value of BIC has decreased. This indicates that Model 2 is a better fit, explaining 79% of the variation in the Average Overall Score. In Model 3 adding an additional independent variable has increased the value of R-Squared somewhat, however the value of BIC is greater than for Model 2. Therefore Model 2 is the preferred model. 

#### Using Model 2 to predict the Average Overall Score

$$\widehat{av.overall.rating} =  1.096 av.aspace * 0.785 av.recline - 1.349$$
```{r}
overall_model_2_augm <- augment(overall_model_2, all_airlines_summary) #Using augment to obtain fitted values and residuals
overall_model_2_augm
```

```{r}
# Examine residuals
overall_model_2_augm %>% ggplot(aes(x=av_overall_rating, y=.resid)) + 
  geom_point() +
  labs(title = "Residual against fitted value")
```

***
# __SUMMARY OF RESULTS__
The SkyTrax airline passenger seat reviews...

***
# __CONCLUSION__
The overall conclusion...

***
# __REFERENCES__
Ref 1 https://raw.githubusercontent.com/quankiquanki/skytrax-reviews-dataset/master/data/seat.csv" (use overall page instead)
Ref 2 https://bookdown.org/yihui/rmarkdown/html-document.html
Ref 3 https://www.airlinequality.com
Ref 4 https://dplyr.tidyverse.org/articles/rowwise.html



# Plots

## Which airlines are the most frequently rated?
A bar chart may be used to display the airlines with the highest numbers of reviews. The key aesthetics will be variables airline_name and a new variable: no_of_reviews. The geom function will be geom_bar. 

## How does overall rating vary amoungst the most frequently rated airlines?
A box-plot can show the distribution of the values. Plan to use a series of side-by-side box-plots represetning the airlines. The variables airline_name and overall_rating will be the aesthetics. Functions geom_boxplot() and geom_jitter() give the box-plot and overly the data points as well. 
                   
                       
## How is the average category rating distributed across the most frequently rated airlines?
A histogram or density plot may be used to show this distribution. A new variable for the average value of the category ratings must be calculated. This will be plotted using geom_density() function and the plot faceted by airline_name to show the distribution for the twelve most frequently rated airlines.

## How does overall rating vary between the major aircraft makes: Boeing, Airbus and Embraer?
A box-plot with variables overall_rating and aircraft_make as the aesthetics. The data set will be filtered to aircraft_make values of Boeing, Airbus and Embraer.

## Which aircraft models show the best overall rating results?
A box-plot with variables overall_rating and aircraft_model as the aesthetics.


